<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Performance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .student-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .student-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .student-header h2 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .topic-section {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .topic-header {
            margin-bottom: 15px;
        }

        .topic-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .topic-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .stat-badge.skill {
            background: #e3f2fd;
            color: #1976d2;
        }

        .stat-badge.total {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .stat-badge.accuracy {
            background: #fff3e0;
            color: #e65100;
        }

        .subtopic-section {
            background: white;
            padding: 15px;
            margin: 15px 0 15px 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .subtopic-title {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .mistake-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .mistake-pill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mistake-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .frequency-badge {
            background: rgba(255,255,255,0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 1200px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        .close {
            color: #aaa;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .question-card {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .question-number {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .question-text {
            margin: 15px 0;
            line-height: 1.6;
            color: #333;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .answer-section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .answer-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .answer-content {
            color: #555;
            line-height: 1.6;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .marks-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .marks-badge.full {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .marks-badge.partial {
            background: #fff9c4;
            color: #f57f17;
        }

        .marks-badge.zero {
            background: #ffcdd2;
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }

        .no-mistakes {
            color: #666;
            font-style: italic;
            padding: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Performance Dashboard</h1>
        <div id="dashboard" class="loading">Loading data...</div>
    </div>

    <!-- Modal for displaying questions -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span class="close">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Parse CSV data
        async function parseCSV() {
            const response = await fetch('dataset_with_mistake_tags - Sheet2 (1).csv');
            const text = await response.text();

            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]);

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index];
                        });
                        data.push(row);
                    }
                }
            }

            return data;
        }

        // Parse a single CSV line handling quotes and commas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"' && nextChar === '"') {
                    current += '"';
                    i++;
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result;
        }

        // Structure data by student -> topic -> subtopic -> mistakes
        function structureData(data) {
            const students = {};

            data.forEach(row => {
                const studentId = row.student_id;
                const topic = row.Topic;
                const subtopic = row.Subtopic;
                const mistakeCategory = row['mistake category'];
                const isMistake = row['Mistake?'] === 'y';
                const skillLevel = row['topical skill level'];

                // Initialize student
                if (!students[studentId]) {
                    students[studentId] = {};
                }

                // Initialize topic
                if (!students[studentId][topic]) {
                    students[studentId][topic] = {
                        skillLevel: skillLevel,
                        subtopics: {},
                        totalQuestions: 0,
                        mistakeCount: 0
                    };
                }

                // Initialize subtopic
                if (!students[studentId][topic].subtopics[subtopic]) {
                    students[studentId][topic].subtopics[subtopic] = {
                        mistakes: {},
                        questions: []
                    };
                }

                // Count totals
                students[studentId][topic].totalQuestions++;
                if (isMistake) {
                    students[studentId][topic].mistakeCount++;
                }

                // Add question to subtopic
                students[studentId][topic].subtopics[subtopic].questions.push(row);

                // Track mistake categories with frequency
                if (isMistake && mistakeCategory) {
                    if (!students[studentId][topic].subtopics[subtopic].mistakes[mistakeCategory]) {
                        students[studentId][topic].subtopics[subtopic].mistakes[mistakeCategory] = {
                            count: 0,
                            questions: []
                        };
                    }
                    students[studentId][topic].subtopics[subtopic].mistakes[mistakeCategory].count++;
                    students[studentId][topic].subtopics[subtopic].mistakes[mistakeCategory].questions.push(row);
                }
            });

            return students;
        }

        // Strip HTML tags for display
        function stripHTML(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Render the dashboard
        function renderDashboard(students) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            dashboard.className = '';

            const studentIds = Object.keys(students).sort();

            if (studentIds.length === 0) {
                dashboard.innerHTML = '<div class="empty-state">No student data found.</div>';
                return;
            }

            studentIds.forEach(studentId => {
                const studentData = students[studentId];
                const studentSection = document.createElement('div');
                studentSection.className = 'student-section';

                studentSection.innerHTML = `
                    <div class="student-header">
                        <h2>Student ID: ${studentId}</h2>
                    </div>
                `;

                const topics = Object.keys(studentData).sort();

                topics.forEach(topic => {
                    const topicData = studentData[topic];
                    const accuracy = topicData.totalQuestions > 0
                        ? ((topicData.mistakeCount / topicData.totalQuestions) * 100).toFixed(1)
                        : 0;

                    const topicSection = document.createElement('div');
                    topicSection.className = 'topic-section';

                    topicSection.innerHTML = `
                        <div class="topic-header">
                            <div class="topic-title">${topic}</div>
                            <div class="topic-stats">
                                <span class="stat-badge skill">Skill Level: ${topicData.skillLevel}</span>
                                <span class="stat-badge total">Total Questions: ${topicData.totalQuestions}</span>
                                <span class="stat-badge accuracy">Mistake Rate: ${accuracy}%</span>
                            </div>
                        </div>
                    `;

                    const subtopics = Object.keys(topicData.subtopics).sort();

                    subtopics.forEach(subtopic => {
                        const subtopicData = topicData.subtopics[subtopic];
                        const subtopicSection = document.createElement('div');
                        subtopicSection.className = 'subtopic-section';

                        subtopicSection.innerHTML = `
                            <div class="subtopic-title">${subtopic}</div>
                            <div class="mistake-pills" id="pills-${studentId}-${topic}-${subtopic}"></div>
                        `;

                        const pillsContainer = subtopicSection.querySelector('.mistake-pills');
                        const mistakes = Object.keys(subtopicData.mistakes).sort();

                        if (mistakes.length === 0) {
                            pillsContainer.innerHTML = '<div class="no-mistakes">No mistakes in this subtopic</div>';
                        } else {
                            mistakes.forEach(mistakeCategory => {
                                const mistakeData = subtopicData.mistakes[mistakeCategory];
                                const pill = document.createElement('div');
                                pill.className = 'mistake-pill';
                                pill.innerHTML = `
                                    <span class="frequency-badge">${mistakeData.count}x</span>
                                    <span>${mistakeCategory}</span>
                                `;

                                pill.addEventListener('click', () => {
                                    showQuestions(mistakeCategory, mistakeData.questions, studentId, topic, subtopic);
                                });

                                pillsContainer.appendChild(pill);
                            });
                        }

                        topicSection.appendChild(subtopicSection);
                    });

                    studentSection.appendChild(topicSection);
                });

                dashboard.appendChild(studentSection);
            });
        }

        // Show questions in modal
        function showQuestions(mistakeCategory, questions, studentId, topic, subtopic) {
            const modal = document.getElementById('questionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `${mistakeCategory} - ${subtopic}`;
            modalBody.innerHTML = '';

            questions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';

                const maxMark = parseFloat(q.maximum_mark) || 0;
                const awardedMark = parseFloat(q.mark_awarded) || 0;
                let markClass = 'zero';
                if (awardedMark === maxMark) markClass = 'full';
                else if (awardedMark > 0) markClass = 'partial';

                let questionHTML = `
                    <div class="question-number">Question ${index + 1}</div>
                    <div class="question-text">
                        <strong>Question:</strong><br>
                        ${q.q_text || q.q_text1 || 'No question text available'}
                    </div>
                `;

                if (q.q_image && q.q_image.trim() && q.q_image !== '""') {
                    questionHTML += `
                        <div>
                            <img src="${q.q_image}" class="question-image" alt="Question image" onerror="this.style.display='none'">
                        </div>
                    `;
                }

                questionHTML += `
                    <div class="answer-section">
                        <div class="answer-label">Model Solution:</div>
                        <div class="answer-content">${q['model solution'] || 'Not provided'}</div>
                    </div>
                    <div class="answer-section">
                        <div class="answer-label">Student Answer:</div>
                        <div class="answer-content">${q['student answer'] || 'No answer provided'}</div>
                    </div>
                    <div>
                        <span class="marks-badge ${markClass}">
                            Marks: ${awardedMark} / ${maxMark}
                        </span>
                    </div>
                `;

                questionCard.innerHTML = questionHTML;
                modalBody.appendChild(questionCard);
            });

            modal.style.display = 'block';
        }

        // Modal controls
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('questionModal').style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            const modal = document.getElementById('questionModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Initialize dashboard
        async function init() {
            try {
                const data = await parseCSV();
                const students = structureData(data);
                renderDashboard(students);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dashboard').innerHTML =
                    '<div class="empty-state">Error loading data. Please make sure the CSV file is in the same directory.</div>';
            }
        }

        init();
    </script>
</body>
</html>
